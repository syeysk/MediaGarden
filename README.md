# Приложения для работы с личным хранилищем

Приложения:
- Library Storage Scanner - сканер хранилища книг. Используется для обнаружения дублей файлов, генерации diff-архива для переноса обновлений между копиями хранилища, генерации списка (структуры) книг хранилища
- Notes Storage Scanner - сканер хранилища заметок. Используется для обнаружения деффектов в организации заметок, публикации заметок на внешние сервисы.

## Library Storage Scanner

Основные задачи, поставленные перед программой:
- неудаление из основного хранилища тех файлов, которые отсутствуют в копиях
- уведомление о дублированных файлах, даже если у них различаются имя и директория

На данный момент скрипт можно использовать для:
- нахождения дублирующихся/переименованных/перемещённых/удалённых/новых файлов
- выгрузки списка всех файлов и каталогов в csv и последующего поиска через текстовый редактор
- обмена списком имеющихся файлов с коллегами, чтобы понимать, у кого какой файл есть
- выгрузка diff-файла с описанием, какие файлы были переименованы/перемещёны/удалёны/добавлены, для применения изменений в оригинальное хранилище

### Как работает программа

#### Сканирование оригинального хранилища

Сканирование выполняет метод `scan_to_db` класса `LibraryStorage`. Перед сканированиевсе файлов всем находящимся файлам в базе данных проставляется флаг удалённости.

При добавлении/переименовании/удалении/перемещении в оригинальном хранилище допустимо его просканировать повторно.
В процессе сканирования при обнаружении:
- дубликата по хешу и пути - ничего не произойдёт, так как это тот же файл.
- нового файла - он добавится в базу данных
- перименованного/перемещённого файла - обновит в базе данных запись о нём

Удалённые с диска файлы не удаляются из базы данных. Если это сделать, то при добавлении вновь он изменит свой идентификатор, что сделает в заметках ссылки на него невалидными.

#### Сканирование копии хранилища

В процессе сканирования при обнаружении:
- дубликата по хешу (с любым именем и путём) - ничего не произойдёт, так как любой дубль нам не нужен.
- нового файла - он добавится в базу данных

### Roadmap

- [x] показ удалённых файлов
- [x] сохранение изменений в diff-файл
- [x] копирование новых файлов в diff-директорию
- [x] применение diff-файла и диреткории
- [x] экспорт в csv с учётом удалённых файлов
- [ ] показ изменённых файлов
- [ ] тесты
    - [ ] генерация csv
    - [ ] генерация diff
    - [ ] csv обновлённой базы должен совпасть с csv оригинальной базы + diff 
    - [ ] генерация csv с учётом удалённых файлов
- [ ] сделать скрипт с готовым конфигом для:
    - [ ] генерации csv оригинальной базы
    - [ ] выгрузки diff из изменённой базы
    - [ ] применения diff к оригинальной базе
- [ ] отмена diff-файла (откат изменений)

### Using

1. Просканируйте оригинальное хранилище:
    ```sh
    syeysk-stor scan --path <path/to/original_storage> --struct <struct.csv>
    ```
    где `--path` - оригинальное хранилище, которое будет просканировано, `--struct` - файл, куда запишется структура хранилища.

2. Просканируйте копию хранилища (в которую Вы могли добавить новые файлы):
    ```sh
    syeysk-stor makediff --path <path/to/copy_storage> --struct <struct.csv> --diff <diff_of_copy_storage>
    ```
    где `--path` - копия хранилища, `--struct` - файл со структурой оригинального хранилища, `--diff` - куда запишется diff-файл с изменениями в копии относительно оригинала 

3. Примените изменния из копии хранилища в оригинальное хранилище:
    ```sh
    syeysk-stor applydiff --path <path/to/original_storage> --diff <diff_of_copy_storage>
    ```
    где `--path` - оригинальное хранилище, `--diff` - diff-файл копии хранилища

После этого оринальное хранилище будет соответствовать копии.

## Notes Storage Scanner

### Roadmap

- [x] публикация заметок на разные сервисы
- [x] сохранение метаинформации (дата публикации, хеш тела заметки без заголовка, идентификатор заметки на внешнем сервисе) в заметку после её публикаци
- [x] публикация заметки на syeysk.ru
- [ ] публикация заметки на developsoc.ru
- [ ] публикация заметки на github.com/TVP-Support/knowledge
